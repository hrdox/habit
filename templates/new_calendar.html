{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h2>Calendar</h2>
    <!-- Legend -->
    <div style="display: flex; gap: 1rem; font-size: 0.8rem;">
        <div style="display: flex; align-items: center; gap: 0.3rem;">
            <span style="width: 10px; height: 10px; background-color: #6366f1; border-radius: 50%;"></span> Classes
        </div>
        <div style="display: flex; align-items: center; gap: 0.3rem;">
            <span style="width: 10px; height: 10px; background-color: #10b981; border-radius: 50%;"></span> Islamic
        </div>
    </div>
</div>

<div class="card" style="padding: 0;">
    <div id='calendar' style="padding: 1.5rem;"></div>
</div>

<!-- Day Details Modal -->
<div id="dayModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalDate">Date</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div id="modalBody">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div class="spinner" style="display: none;">Loading...</div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            selectable: true, // Allows clicking days
            dateClick: function (info) {
                openDayModal(info.dateStr);
            },
            events: '/api/events',
            eventClick: function (info) {
                // Optional: Show event details
                alert('Event: ' + info.event.title);
            }
        });
        calendar.render();
    });

    const modal = document.getElementById('dayModal');
    const modalDate = document.getElementById('modalDate');
    const modalBody = document.getElementById('modalBody');

    function closeModal() {
        modal.classList.remove('active');
    }

    async function openDayModal(dateStr) {
        modal.classList.add('active');
        modalDate.textContent = 'Loading...';
        modalBody.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Fetching Day Significance...</p>';

        try {
            const res = await fetch(`/api/day_details?date=${dateStr}`);

            if (!res.ok) {
                throw new Error(`Server returned ${res.status}`);
            }

            const data = await res.json();

            if (data.error) {
                modalBody.innerHTML = `<p class="text-danger">${data.error}</p>`;
                return;
            }

            modalDate.textContent = data.date;

            let html = '';

            // Significance (History)
            html += '<h3>üåç Historical Events</h3>';
            html += '<ul style="margin-bottom: 1.5rem; padding-left: 1.2rem;">';
            if (data.significance && data.significance.length > 0) {
                data.significance.forEach(item => {
                    html += `<li style="margin-bottom: 0.5rem;">${item}</li>`;
                });
            }
            html += '</ul>';

            // Daily Reflection (Quran/Hadith)
            if (data.reflection) {
                html += '<div style="background-color: var(--bg-surface); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid #8b5cf6;">';
                html += '<h4 style="margin-top: 0; color: #8b5cf6;">üìñ Daily Reflection</h4>';
                html += `<p style="font-style: italic; margin: 0;">${data.reflection}</p>`;
                html += '</div>';
            }

            // Dua
            if (data.dua) {
                html += '<div style="background-color: var(--bg-body); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid var(--primary);">';
                html += '<h4 style="margin-top: 0; color: var(--primary);">ü§≤ Recommended Dua</h4>';
                html += `<p style="font-family: 'Amiri', serif; font-size: 1.2rem; margin: 0.5rem 0;">${data.dua.arabic}</p>`;
                html += `<p style="font-style: italic; margin-bottom: 0.5rem;">${data.dua.meaning}</p>`;
                html += `<p style="font-size: 0.9rem; color: var(--text-muted); margin: 0;"><strong>${data.dua.title}</strong></p>`;
                html += '</div>';
            }

            modalBody.innerHTML = html;

        } catch (e) {
            console.error(e);
            modalBody.innerHTML = '<p class="text-danger">Failed to load details. Please try again.</p>';
        }
    }

    // Close modal on outside click (handled by specific JS or CSS helper if needed, 
    // but scripts.js has generic sidebar closer, let's add specific modal closer here or relying on the button)
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });
</script>
{% endblock %}
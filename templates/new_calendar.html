{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h2>Calendar</h2>
    <!-- Legend -->
    <div style="display: flex; gap: 1rem; font-size: 0.8rem;">
        <div style="display: flex; align-items: center; gap: 0.3rem;">
            <span style="width: 10px; height: 10px; background-color: #6366f1; border-radius: 50%;"></span> Classes
        </div>
        <div style="display: flex; align-items: center; gap: 0.3rem;">
            <span style="width: 10px; height: 10px; background-color: #10b981; border-radius: 50%;"></span> Islamic
        </div>
    </div>
</div>

<div class="card" style="padding: 0;">
    <div id='calendar' style="padding: 1.5rem;"></div>
</div>
{% endblock %}

{% block modals %}
<!-- Day Details Modal -->
<div id="dayModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalDate">Date</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div id="modalBody">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div class="spinner" style="display: none;">Loading...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            height: 'auto',
            contentHeight: 'auto',
            aspectRatio: window.innerWidth < 768 ? 0.8 : 1.5,
            headerToolbar: {
                left: window.innerWidth < 768 ? 'prev,next' : 'prev,next today',
                center: 'title',
                right: window.innerWidth < 768 ? 'dayGridMonth,listWeek' : 'multiMonthYear,dayGridMonth,timeGridWeek,listWeek'
            },
            views: {
                multiMonthYear: {
                    buttonText: 'Year'
                },
                dayGridMonth: {
                    buttonText: 'Month'
                },
                timeGridWeek: {
                    buttonText: 'Week'
                },
                listWeek: {
                    buttonText: 'List'
                }
            },
            selectable: true,
            nowIndicator: true,
            dayMaxEvents: true, // allow "more" link when too many events
            dateClick: function (info) {
                openDayModal(info.dateStr);
            },
            events: '/api/events',
            eventClick: function (info) {
                // For mobile, make clicks trigger the modal as well
                openDayModal(info.event.startStr.split('T')[0]);
            },
            windowResize: function (view) {
                // Adjust toolbar and aspect ratio on resize
                const isMobile = window.innerWidth < 768;
                calendar.setOption('aspectRatio', isMobile ? 0.8 : 1.5);
                calendar.setOption('headerToolbar', {
                    left: isMobile ? 'prev,next' : 'prev,next today',
                    center: 'title',
                    right: isMobile ? 'dayGridMonth,listWeek' : 'multiMonthYear,dayGridMonth,timeGridWeek,listWeek'
                });
            }
        });
        calendar.render();
    });

    const modal = document.getElementById('dayModal');
    const modalDate = document.getElementById('modalDate');
    const modalBody = document.getElementById('modalBody');

    function closeModal() {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }

    async function openDayModal(dateStr) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        modalDate.textContent = 'Loading...';
        modalBody.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Fetching Day Significance...</p>';

        try {
            const res = await fetch(`/api/day_details?date=${dateStr}`);

            if (!res.ok) {
                throw new Error(`Server returned ${res.status}`);
            }

            const data = await res.json();

            if (data.error) {
                modalBody.innerHTML = `<p class="text-danger">${data.error}</p>`;
                return;
            }

            modalDate.textContent = data.date;

            let html = '';

            // Day Overview (New)
            if (data.day_overview) {
                html += '<div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 1.25rem; border-radius: 0.75rem; margin-bottom: 1.5rem; box-shadow: var(--shadow-md);">';
                html += '<h3 style="margin-top: 0; color: white; display: flex; justify-content: space-between;">üåü Day Overview <span style="font-size: 0.9rem; opacity: 0.9;">Score: ' + data.day_overview.total_score + '</span></h3>';
                if (data.day_overview.intention) {
                    html += '<p style="margin: 0.5rem 0; font-weight: 600;">üéØ Intention: ' + data.day_overview.intention + '</p>';
                }
                html += '<div style="display: flex; gap: 1rem; font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.9;">';
                html += '<span>‚ö° Energy: ' + data.day_overview.energy_level + '/5</span>';
                html += '<span>üòä Mood: ' + data.day_overview.mood + '/5</span>';
                html += '</div>';
                if (data.day_overview.reflection) {
                    html += '<p style="margin-top: 0.75rem; font-size: 0.9rem; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 0.5rem;">üìù Reflection: ' + data.day_overview.reflection + '</p>';
                }
                html += '</div>';
            }

            // Significance (History)
            html += '<h3>üåç Historical Events</h3>';
            html += '<ul style="margin-bottom: 1.5rem; padding-left: 1.2rem; color: var(--text-main); font-size: 0.95rem;">';
            if (data.significance && data.significance.length > 0) {
                data.significance.forEach(item => {
                    html += `<li style="margin-bottom: 0.5rem;">${item}</li>`;
                });
            }
            html += '</ul>';



            // Daily Reflection (Quran/Hadith)
            if (data.reflection || data.hadith) {
                html += '<div style="background-color: var(--bg-surface); padding: 1.25rem; border-radius: 0.75rem; margin-bottom: 1.5rem; border-left: 5px solid #8b5cf6;">';
                html += '<h4 style="margin-top: 0; color: #8b5cf6;">üìñ Daily Verse/Hadith</h4>';

                // Quran Part
                if (data.reflection) {
                    if (typeof data.reflection === 'object') {
                        html += `<p style="font-family: 'Amiri', serif; font-size: 1.4rem; margin: 1rem 0; color: var(--text-main); text-align: right; direction: rtl; line-height: 1.8;">${data.reflection.arabic}</p>`;
                        html += `<p style="font-style: italic; color: var(--text-main); line-height: 1.5; margin-bottom: 0.5rem;">${data.reflection.english}</p>`;
                        html += `<p style="margin: 0 0 1rem 0; font-size: 0.85rem; color: var(--text-muted); text-align: right;"><strong>${data.reflection.reference}</strong></p>`;
                    } else {
                        html += `<p style="margin-bottom: 1rem; line-height: 1.5;">${data.reflection}</p>`;
                    }
                }

                // Divider if both exist
                if (data.reflection && data.hadith) {
                    html += '<hr style="border: 0; border-top: 1px solid rgba(0,0,0,0.1); margin: 1rem 0; opacity: 0.5;">';
                }

                // Hadith Part
                if (data.hadith) {
                    html += `<p style="margin: 0; line-height: 1.5; font-style: italic; color: var(--text-main);">"${data.hadith.text}"</p>`;
                    html += `<p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted); text-align: right;">‚Äî ${data.hadith.source}</p>`;
                }

                html += '</div>';
            }

            // Dua
            if (data.dua) {
                html += '<div style="background-color: var(--bg-body); padding: 1.25rem; border-radius: 0.75rem; border-left: 5px solid var(--primary);">';
                html += '<h4 style="margin-top: 0; color: var(--primary);">ü§≤ Recommended Dua</h4>';
                html += `<p style="font-family: 'Amiri', serif; font-size: 1.3rem; margin: 0.75rem 0; color: var(--text-main); text-align: right; direction: rtl;">${data.dua.arabic}</p>`;
                html += `<p style="font-style: italic; margin-bottom: 0.5rem; color: var(--text-main);">${data.dua.meaning}</p>`;
                html += `<p style="font-size: 0.85rem; color: var(--text-muted); margin: 0;"><strong>${data.dua.title}</strong></p>`;
                html += '</div>';
            }

            modalBody.innerHTML = html;

        } catch (e) {
            console.error(e);
            modalBody.innerHTML = '<p class="text-danger">Failed to load details. Please try again.</p>';
        }
    }

    // Close modal on outside click (handled by specific JS or CSS helper if needed, 
    // but scripts.js has generic sidebar closer, let's add specific modal closer here or relying on the button)
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Analytics{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Summary Cards -->
    <div class="summary-stats-grid">
        <div class="stat-summary-card card">
            <div class="stat-emoji">üî•</div>
            <h3 class="stat-value"><span id="best-day">0</span></h3>
            <p>Best Score (All Time)</p>
        </div>
        <div class="stat-summary-card card">
            <div class="stat-emoji">‚≠ê</div>
            <h3 class="stat-value"><span id="avg-daily">0</span></h3>
            <p>Daily Average</p>
        </div>
        <div class="stat-summary-card card">
            <div class="stat-emoji">üìà</div>
            <h3 class="stat-value"><span id="total-score">0</span></h3>
            <p>Score (Last 30 Days)</p>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid-analytics">
        <!-- Main Line Chart -->
        <div class="card full-width-chart">
            <div class="chart-header">
                <h3>Overall Progress</h3>
                <div class="chart-actions">
                    <select id="time-range" class="modern-select-small" onchange="loadAnalytics()">
                        <option value="7">Last 7 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>
            </div>
            <div class="chart-body">
                <canvas id="scoreChart"></canvas>
            </div>
        </div>

        <!-- Breakdown Chart -->
        <div class="card">
            <div class="chart-header">
                <h3>Habits vs Prayers</h3>
            </div>
            <div class="chart-body secondary">
                <canvas id="breakdownChart"></canvas>
            </div>
        </div>

        <!-- Doughnut Chart -->
        <div class="card">
            <div class="chart-header">
                <h3>Consistency Overview</h3>
            </div>
            <div class="chart-body secondary">
                <canvas id="consistencyChart"></canvas>
            </div>
        </div>
    </div>
</div>

<style>
    .analytics-container {
        padding-bottom: 2rem;
    }

    /* Summary Stats Grid - Responsive */
    .summary-stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin-bottom: 2.5rem;
    }

    .stat-summary-card {
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2.5rem 1.5rem;
        border-radius: 20px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .stat-summary-card:hover {
        transform: translateY(-8px);
    }

    .stat-emoji {
        font-size: 3rem;
        margin-bottom: 0.75rem;
    }

    .stat-value {
        font-size: 2.4rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        color: var(--text-main);
        font-family: 'Outfit', sans-serif;
    }

    .stat-summary-card p {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Charts Grid */
    .charts-grid-analytics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
    }

    .full-width-chart {
        grid-column: span 2;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .chart-header h3 {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-main);
    }

    .chart-body {
        height: 350px;
        position: relative;
    }

    .chart-body.secondary {
        height: 280px;
    }

    .modern-select-small {
        padding: 0.5rem 1rem;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        background: var(--bg-surface);
        color: var(--text-main);
        font-size: 0.9rem;
        font-weight: 600;
        outline: none;
    }

    /* Mobile Responsive Logic */
    @media (max-width: 1024px) {
        .summary-stats-grid {
            gap: 1rem;
        }

        .stat-summary-card {
            padding: 2rem 1rem;
        }
    }

    @media (max-width: 768px) {

        .summary-stats-grid,
        .charts-grid-analytics {
            grid-template-columns: 1fr;
        }

        .full-width-chart {
            grid-column: span 1;
        }

        .stat-emoji {
            font-size: 2.5rem;
        }

        .stat-value {
            font-size: 2rem;
        }

        .chart-body {
            height: 250px;
        }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let scoreChartInstance = null;
    let breakdownChartInstance = null;
    let consistencyChartInstance = null;

    document.addEventListener('DOMContentLoaded', () => {
        loadAnalytics();
    });

    async function loadAnalytics() {
        const days = document.getElementById('time-range').value;
        try {
            const res = await fetch(`/api/analytics_data?days=${days}`);
            const data = await res.json();

            // Update Summary
            document.getElementById('best-day').innerText = data.summary.best_day;
            document.getElementById('avg-daily').innerText = data.summary.avg_daily;
            document.getElementById('total-score').innerText = data.summary.total_all_time;

            // Render Charts
            renderScoreChart(data);
            renderBreakdownChart(data);
            renderConsistencyChart(data);

        } catch (e) {
            console.error("Failed to load analytics:", e);
        }
    }

    function renderScoreChart(data) {
        const ctx = document.getElementById('scoreChart').getContext('2d');
        if (scoreChartInstance) scoreChartInstance.destroy();

        scoreChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Total Score',
                        data: data.total_scores,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

    function renderBreakdownChart(data) {
        const ctx = document.getElementById('breakdownChart').getContext('2d');
        if (breakdownChartInstance) breakdownChartInstance.destroy();

        breakdownChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Habits',
                        data: data.habit_scores,
                        backgroundColor: '#10b981',
                        borderRadius: 6
                    },
                    {
                        label: 'Prayers',
                        data: data.prayer_scores,
                        backgroundColor: '#3b82f6',
                        borderRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                },
                scales: {
                    x: { stacked: true, grid: { display: false } },
                    y: { stacked: true, beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }
                }
            }
        });
    }

    function renderConsistencyChart(data) {
        const totalHabit = data.habit_scores.reduce((a, b) => a + b, 0);
        const totalPrayer = data.prayer_scores.reduce((a, b) => a + b, 0);

        const ctx = document.getElementById('consistencyChart').getContext('2d');
        if (consistencyChartInstance) consistencyChartInstance.destroy();

        consistencyChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Habit Score', 'Prayer Score'],
                datasets: [{
                    data: [totalHabit, totalPrayer],
                    backgroundColor: ['#10b981', '#3b82f6'],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                },
                cutout: '70%'
            }
        });
    }
</script>
{% endblock %}
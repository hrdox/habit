{% extends "base.html" %}

{% block content %}
<div class="dashboard-grid">
    <!-- Main Left Column -->
    <div style="grid-column: span 2;">
        <h2>Welcome back, {{ current_user.username }}!</h2>
        <p class="text-muted">{{ today.strftime('%A, %B %d, %Y') }}</p>


        <!-- 2. Schedule Section -->
        <div class="card">
            <h3>Today's Schedule</h3>
            {% if routines %}
            {% for item in routines %}
            <div
                style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>{{ item.start_time.strftime('%I:%M %p') }} - {{ item.end_time.strftime('%I:%M %p')
                        }}</strong>
                    <div style="margin-top: 0.25rem; font-weight: 500;">{{ item.title }}</div>
                    <small style="color: var(--text-muted); opacity: 0.8;">üìç {{ item.location or 'No Location'
                        }}</small>
                </div>
                <div>
                    {% if schedule_status.get(item.id) %}
                    <button class="btn"
                        style="background-color: var(--secondary); color: white; padding: 0.2rem 0.5rem; font-size: 0.8rem;"
                        onclick="toggleRoutine({{ item.id }}, this)">‚úÖ Done</button>
                    {% else %}
                    <button class="btn btn-outline" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;"
                        onclick="toggleRoutine({{ item.id }}, this)">Mark Done</button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p>No classes or routines today.</p>
            {% endif %}
            <br>
            <a href="{{ url_for('schedule_view') }}" class="btn btn-primary"
                style="width: 100%; text-align: center;">Manage Schedule</a>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0;">Today's Habits</h3>
                <a href="{{ url_for('habits_list') }}" class="btn btn-outline"
                    style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Manage All</a>
            </div>
            {% if habits %}
            {% for habit in habits %}
            <div class="habit-item">
                <div style="display: flex; gap: 0.75rem; align-items: center;">
                    <div>
                        <strong>{{ habit.name }}</strong>
                        <span style="font-size: 0.8rem; color: var(--text-muted); display: block;">
                            {{ habit.category }}
                            <!-- | <a href="{{ url_for('edit_habit', habit_id=habit.id) }}"
                                style="font-size: 0.75rem;">Edit</a> -->
                        </span>
                    </div>
                </div>
                <div>
                    {% set log = habit_logs.get(habit.id) %}
                    {% set done_val = log.value_done if log else 0 %}
                    {% set is_done = log.status if log else False %}

                    {% if habit.target_value > 1 %}
                    <!-- Multi-step Habit -->
                    <div style="text-align: right;">
                        <span
                            style="font-size: 0.8rem; font-weight: bold; margin-right: 0.5rem; color: var(--text-muted);">
                            {{ done_val }} / {{ habit.target_value }}
                        </span>
                        {% if is_done %}
                        <button class="btn"
                            style="background-color: var(--secondary); color: rgb(0, 0, 0); padding: 0.4rem 0.8rem;"
                            onclick="toggleHabit({{ habit.id }}, this)">Target Hitted <br> (Reset)</button>
                        {% else %}
                        <button class="btn btn-primary" style="padding: 0.4rem 0.8rem;"
                            onclick="toggleHabit({{ habit.id }}, this)">+1 Track</button>
                        {% endif %}
                    </div>
                    {% else %}
                    <!-- Simple Boolean Habit -->
                    {% if is_done %}
                    <button class="btn"
                        style="background-color: var(--secondary); color: white; padding: 0.4rem 0.8rem;"
                        onclick="toggleHabit({{ habit.id }}, this)">Undo</button>
                    {% else %}
                    <button class="btn btn-primary" style="padding: 0.4rem 0.8rem;"
                        onclick="toggleHabit({{ habit.id }}, this)">Mark Done</button>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p>No habits added yet. <a href="{{ url_for('habits_list') }}">Add one here</a>.</p>
            {% endif %}
        </div>

        <!-- 4. Prayer Section -->
        <div class="card">
            <h3>Daily Prayers (Salah)</h3>
            <div class="prayer-list">
                {% for p in ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'] %}
                <div class="prayer-item {{ 'completed' if prayer_log and getattr(prayer_log, p) else '' }}"
                    onclick="togglePrayer('{{ p }}', this)">
                    <div class="prayer-name">
                        <span class="check-icon"></span>
                        {{ p|capitalize }}
                    </div>
                    {% if prayer_log and getattr(prayer_log, p) %}
                    <span style="font-size: 0.8rem; color: var(--success); font-weight: 500;">Completed</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <div style="margin-top: 1rem; text-align: center;">
                <p>Spiritual Score: <span id="spiritual-score-display" class="spiritual-score">{{
                        prayer_log.spiritual_score }}</span> / 500</p>
            </div>
        </div>

        <!-- 1. Day Overview (New System V2 Layer) -->
        <div class="card"
            style="border-left: 5px solid var(--primary); background: linear-gradient(to right, var(--bg-card), rgba(var(--primary-rgb), 0.05));">
            <h3 style="display: flex; justify-content: space-between; align-items: center;">
                Day Overview
                <small style="font-size: 0.8rem; opacity: 0.7;">Score: {{ day.total_score }} | Energy: {{
                    day.energy_level }} | Mood: {{ day.mood
                    }}</small>
            </h3>
            <form method="POST" action="{{ url_for('dashboard') }}" id="day-form">
                <div style="margin-bottom: 1rem;">
                    <label style="font-weight: 600; font-size: 0.9rem;">üéØ Daily Intention</label>
                    <input type="text" name="intention" value="{{ day.intention or '' }}"
                        placeholder="What is your ONE main focus today?"
                        style="width: 100%; padding: 0.8rem; margin-top: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem;"
                        onblur="this.form.submit()">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label style="font-weight: 600; font-size: 0.9rem;">‚ö° Energy Level</label>
                        <div class="range-selector" style="display: flex; gap: 0.2rem; margin-top: 0.5rem;">
                            <!-- Simple Select for reliability -->
                            <select name="energy_level" class="form-select" onchange="this.form.submit()"
                                style="width: 100%; padding: 0.5rem; border-radius: 6px;">
                                <option value="1" {% if day.energy_level==1 %}selected{% endif %}>1 - Exhausted</option>
                                <option value="2" {% if day.energy_level==2 %}selected{% endif %}>2 - Low</option>
                                <option value="3" {% if day.energy_level==3 %}selected{% endif %}>3 - Neutral</option>
                                <option value="4" {% if day.energy_level==4 %}selected{% endif %}>4 - Good</option>
                                <option value="5" {% if day.energy_level==5 %}selected{% endif %}>5 - Peak</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label style="font-weight: 600; font-size: 0.9rem;">üòä Mood</label>
                        <select name="mood" class="form-select" onchange="this.form.submit()"
                            style="width: 100%; padding: 0.5rem; border-radius: 6px;">
                            <option value="1" {% if day.mood==1 %}selected{% endif %}>1 - Sad/Anxious</option>
                            <option value="2" {% if day.mood==2 %}selected{% endif %}>2 - Stressed</option>
                            <option value="3" {% if day.mood==3 %}selected{% endif %}>3 - Okay</option>
                            <option value="4" {% if day.mood==4 %}selected{% endif %}>4 - Happy</option>
                            <option value="5" {% if day.mood==5 %}selected{% endif %}>5 - Amazing</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label style="font-weight: 600; font-size: 0.9rem;">üìù End of Day Reflection</label>
                    <textarea name="reflection" placeholder="How did the day go? What did you learn?"
                        style="width: 100%; height: 80px; padding: 0.8rem; margin-top: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px;"
                        onblur="this.form.submit()">{{ day.reflection or '' }}</textarea>
                </div>
            </form>
        </div>

    </div>

    <!-- Sidebar Column -->
    <div>
        <!-- 5. Quick Actions -->
        <div class="card">
            <h3>Quick Actions</h3>
            <ul style="list-style: none; padding: 0;">
                <li style="margin-bottom: 0.5rem;"><a href="{{ url_for('islamic_hub') }}">üìñ Read Daily Dua</a></li>
                <li style="margin-bottom: 0.5rem;"><a href="{{ url_for('habits_list') }}">‚ûï Add New Habit</a></li>
                <li style="margin-bottom: 0.5rem;"><a href="{{ url_for('prayers') }}">‚ò™ Prayer Analytics</a></li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}